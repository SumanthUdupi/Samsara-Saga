import type { RequestHandler } from './$types';import { json } from '@sveltejs/kit';const GEMINI_API_ENDPOINT = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent`;// NEW: A library of AI personas for each NPCconst personas: Record<string, string> = {'village_elder': "You are a wise Village Elder in a game about Hindu philosophy. You speak in simple, kind, and slightly cryptic terms, often using analogies from nature. You are ancient and have seen many souls begin their journey.",'warrior_spirit': "You are the tormented spirit of a warrior who died in the great war at Kurukshetra. You are filled with sorrow and regret. You speak in short, mournful phrases about duty (dharma) and loss. You are bound to this battlefield and cannot leave.",'rishi_narada': "You are the sage Narada. You are wise, cheerful, and known for your mischievous nature and love of storytelling. You travel the three worlds spreading news and occasionally causing well-intentioned trouble. You speak with a poetic and joyful flair.",'gandharva_chitrasena': "You are Chitrasena, the king of the Gandharvas, a celestial musician in Svarga. Your being is attuned to harmony and beauty. You speak eloquently and artistically, often using metaphors of music and sound to describe the universe.",'apsara_urvashi': "You are Urvashi, the most famous of the Apsaras. You are supremely graceful and alluring, but also carry a hint of melancholy from a life of eternal performance. You speak with an ethereal, captivating, and sometimes distant tone.",'asura_maya': "You are Maya, the great Asura architect and artisan. You are a genius of creation and illusion. You are proud, pragmatic, and direct. You respect power and skill above all else and speak with the authority of a master craftsman.",'naga_takshaka': "You are Takshaka, King of the Nagas from the underworld realm of Patala. You are ancient, wise, and dangerous. You guard the secrets of the deep earth and speak in cryptic, sibilant riddles. You are suspicious of outsiders."};export const GET: RequestHandler = async ({ platform, params }) => { /* ... No changes needed from previous version ... */ };export const POST: RequestHandler = async ({ request, platform, params }) => {    const db = platform.env.DB;    const geminiApiKey = platform.env.GEMINI_API_KEY as string;    const { npcId } = params;    const { message } = await request.json();    const { results: playerResults } = await db.prepare('SELECT id FROM Players ORDER BY created_at DESC LIMIT 1').all();    if (!playerResults?.[0]) return json({ error: 'Player not found' }, { status: 404 });    const playerId = playerResults[0].id as string;    const histData = await db.prepare('SELECT history FROM NPC_Conversations WHERE player_id = ? AND npc_id = ?').bind(playerId, npcId).first<{ history: string }>();    const history = histData ? JSON.parse(histData.history) : [];    // DYNAMICALLY SELECT THE PERSONA    const persona = personas[npcId ?? ''] || "You are a generic character."; // Fallback    const prompt = `You are a character in a text-based RPG. Stay in character. Your Persona: ${persona}\n\nConversation History (last 6 turns):\n${history.slice(-6).map((h: any) => `${h.role}: ${h.text}`).join('\n')}\n\nhuman: ${message}\nmodel:`;        const geminiResponse = await fetch(`${GEMINI_API_ENDPOINT}?key=${geminiApiKey}`, {        method: 'POST',        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })    });    if (!geminiResponse.ok) throw new Error('AI response error');    const geminiData = await geminiResponse.json();    const aiResponse = geminiData.candidates[0].content.parts[0].text.trim();    const newHistory = [...history, { role: 'user', text: message }, { role: 'model', text: aiResponse }];    await db.prepare(        `INSERT INTO NPC_Conversations (player_id, npc_id, history) VALUES (?, ?, ?)\n         ON CONFLICT(player_id, npc_id) DO UPDATE SET history = excluded.history`    ).bind(playerId, npcId, JSON.stringify(newHistory)).run();    return json({ response: aiResponse });};